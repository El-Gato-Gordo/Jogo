<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Jogão</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 700 },
            debug: true
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var player;
var platforms;
var cursors;
var gameOver = false;
var last_direction = "null" //Verifica qual a última direção que o jogador se moveu

var game = new Phaser.Game(config);
var player_hp //Define HP do Cavaleiro e Mago
var player_mana //Define Mana do Mago
var parryTime //Define o tempo que pode manter o aparo
var nextParry //Define o cooldown entre parries
var parrying = false //Define se está aparando ou não
var airSpeed = 0 //Aceleração no ar
var dodging = false //Verifica se está esquivando
var dodgingTime = 0 //Tempo da duração da esquiva
var jumpTimer = 0 //Tempo no ar
var jumpTune = 0 

//Declarando teclas do jogo
let keyA;
let keyS;
let keyD;
let keyW;
let keyJ;
let keyK;

let keyNum0;
let keyNum1;
let keyNum2;
let keyNum3;

let keyUp;
let keyDown;
let keyRight;
let keyLeft;

function preload ()
{
    this.load.image('sky', 'assets/sky.png');
    this.load.image('ground', 'assets/platform.png');
    this.load.spritesheet('player', 'assets/player_move.png', { frameWidth: 64, frameHeight: 64 });
}

function create ()
{

    
    //Criando as teclas
    keyA = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
    keyS = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
    keyD = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);
    keyW = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
    keyJ = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.J);
    keyK = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.K);

    keyNum0 = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.NUMPAD_ZERO);
    keyNum1 = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.NUMPAD_ONE);
    keyNum2 = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.NUMPAD_TWO);
    keyNum3 = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.NUMPAD_THREE);

    keyUp = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP); 
    keyDown = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN);
    keyRight = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT); 
    keyLeft = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT); 

    //  A simple background for our game
    this.add.image(400, 300, 'sky').setScale(4);

    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = this.physics.add.staticGroup();

    //  Here we create the ground.
    //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
    platforms.create(400, 568, 'ground').setScale(2).refreshBody();

    //  Now let's create some ledges
    platforms.create(600, 400, 'ground');
    platforms.create(50, 250, 'ground');
    platforms.create(750, 220, 'ground');

    // The player and its settings
    player = this.physics.add.sprite(100, 450, 'player');
    player.setSize(50, 46, false);
    player.setOffset(7, 19);

//  Player physics properties. Give the little guy a slight bounce.
    player.setCollideWorldBounds(true);

    //  Our player animations, turning, walking left and walking right.
    //Anda Esquerda
    this.anims.create({
        key: 'walkLeft',
        frames: this.anims.generateFrameNumbers('player', { start: 35, end: 42 }),
        frameRate: 17,
        repeat: -1
    });

    //Anda Direita
    this.anims.create({
        key: 'idleRight',
        frames: this.anims.generateFrameNumbers('player', {start: 0, end: 13}),
        frameRate: 10,
        repeat: -1
    });

    //Parado Esquerda
    this.anims.create({
        key: 'idleLeft',
        frames: this.anims.generateFrameNumbers('player', {start: 14, end: 27}),
        frameRate: 10,
        repeat: -1
    });

    //Parado Direita
    this.anims.create({
        key: 'walkRight',
        frames: this.anims.generateFrameNumbers('player', { start: 28, end: 34 }),
        frameRate: 17,
        repeat: -1
    });

    //Salto Direita
    this.anims.create({
        key: 'risingRight',
        frames: [ { key: 'player', frame: 43 } ],
        frameRate: 20
    });

    //Queda Direita
    this.anims.create({
        key: 'fallingRight',
        frames: [ { key: 'player', frame: 45 } ],
        frameRate: 20
    });

    //Agacha Direita
    this.anims.create({
        key: 'crouchingRight',
        frames: [ { key: 'player', frame: 47 } ],
        frameRate: 20
    });

    //Agacha Esquerda
    this.anims.create({
        key: 'crouchingLeft',
        frames: [ { key: 'player', frame: 48 } ],
        frameRate: 20
    });

    //Salto Esquerda
    this.anims.create({
        key: 'risingLeft',
        frames: [ { key: 'player', frame: 44 } ],
        frameRate: 20
    });

    //Queda Esquerda
    this.anims.create({
        key: 'fallingLeft',
        frames: [ { key: 'player', frame: 46 } ],
        frameRate: 20
    });

    //Aparo Direita
    this.anims.create({
        key: 'parryRight',
        frames: [ { key: 'player', frame: 70 } ],
        frameRate: 20
    });

    //Aparo Esquerda
    this.anims.create({
        key: 'parryLeft',
        frames: [ { key: 'player', frame: 71 } ],
        frameRate: 20
    });

    //Esquiva Direita
    this.anims.create({
        key: 'dodgeRight',
        frames: this.anims.generateFrameNumbers('player', { start: 60, end: 64 }),
        frameRate: 10,
        repeat: -1
    });

    //Esquiva Esquerda
    this.anims.create({
        key: 'dodgeLeft',
        frames: this.anims.generateFrameNumbers('player', { start: 65, end: 69 }),
        frameRate: 10,
        repeat: -1
    });

    //Corre Direita
    this.anims.create({
        key: 'sprintRight',
        frames: this.anims.generateFrameNumbers('player', { start: 49, end: 54 }),
        frameRate: 20,
        repeat: -1
    });

    //Corre Esquerda
    this.anims.create({
        key: 'sprintLeft',
        frames: this.anims.generateFrameNumbers('player', { start: 55, end: 59 }),
        frameRate: 20,
        repeat: -1
    });

    //  Input Events
    cursors = this.input.keyboard.createCursorKeys(); //Informa que o jogo tem input das keys

    //  Collide the player and the stars with the platforms
    this.physics.add.collider(player, platforms);

}

function update ()
{
    if (gameOver)
    {
        return;
    }

    //Verifica se a tecla CIMA está apertada e se está tocando no chão à baixo    
    if (keyW.isDown)
    {
        
        if (jumpTimer === 0 && player.body.touching.down) { //jumpTimer verifica o tempo que o jogador está no ar
            
            player.setVelocityY(-300); //Altura inicial do salto
            jumpTimer = 1; //Inicia o jumpTimer
            
            }
            else if (jumpTimer > 0 && jumpTimer <= 20) { //Enquanto o jumpTimer estiver entre 1 e 20, vai adicionar 1 ao jumpTimer e à cada verificação vai alterar a velocidade do Y
                
                jumpTimer = jumpTimer + 1;
                jumpTune = -300 + jumpTimer * 4; //Assim, a cada jumpTimer, a velocidade será diminuida por um fator 4 em relação ao timer, tudo isso se segurar o W e o time for menor que 20
                player.setVelocityY(jumpTune)
            }
            

        }
        
    else {
            jumpTimer = 0;
        }

    //Verifica se a velocidade horizontal do jogador está direcionada à direita, o que altera a variável last_direction
    if (player.body.velocity.x > 0)
    {
        last_direction = "RIGHT"
    }
        
    //Verifica se a velocidade horizontal do jogador está direcionada à esquerda, o que altera a variável last_direction
    if (player.body.velocity.x < 0)
    {
        last_direction = "LEFT"
    }

    if (player.body.touching.down) //NO CHÃO
    {
        player.setSize(50, 46, false); //Normaliza tamanho da hitbox do jogador
        player.setOffset(7, 19); //Ajusta a posição da hitbox do jogador

        if (dodgingTime > 25) //Se o tempo de esquiva houver passado
        {   
            dodging = false
            dodgingCooldown = dodgingCooldown + 1
            
            if (dodgingCooldown >= 50) //Cooldown para se esquivar
            {
                dodgingTime = 0
            } 
        }

        if (keyK.isDown || dodging === true)
        {
            if (dodgingTime <= 25) //Enquanto o tempo de esquiva não houver passado
            {

            dodging = true
            dodgingCooldown = 0
            dodgingTime = dodgingTime + 1

            if (last_direction === "RIGHT")
            {

                player.anims.play('dodgeRight', true)
                player.setVelocityX(500)

            }

            if (last_direction === "LEFT")
            {

                player.anims.play('dodgeLeft', true)
                player.setVelocityX(-500)
            }

            
            }
            else {

                
                dodging = false
            }
        }


        //Evasão tem prioridade máxima
        else if (dodging === false)

        {
    
        //Andar e Correr ESQUERDA
        if (keyA.isDown)
        {
            if (cursors.shift.isDown)
            {
                player.setVelocityX(-300);

                player.anims.play('sprintLeft', true)
                
            }
            else 
            {

            player.setVelocityX(-160);

            if (player.body.touching.down){}
                player.anims.play('walkLeft', true);
            
            }
        }

        //Andar e Correr DIREITA
        else if (keyD.isDown)  
        {
            if (cursors.shift.isDown)
            {
                player.setVelocityX(300);

                player.anims.play('sprintRight', true)

            }
            else 
            {

            player.setVelocityX(160);

            player.anims.play('walkRight', true)

            }
        }

        //Se estiver parado no chão
        else
        {
            player.setVelocityX(0);

            //A variável last_direction serve para checar para qual direção o jogador estava olhando antes de soltar os botões LEFT e RIGHT,
            //Assim podemos usar sprites de IDLE diferentes

            //Verifica se está apertando S para agachar
            if (keyS.isDown)
            {

                //Muda a hitbox do personagem para ficar devidamente agachado
                player.setSize(49, 35, true);
                player.setOffset(7, 30);
                
                //Agachado para direita
                if (last_direction === "RIGHT")
                {
                    player.anims.play('crouchingRight', true)
                }

                //Agachado para esquerda
                else if (last_direction === "LEFT")
                {
                    player.anims.play('crouchingLeft', true);
                }

            }

            //Se não estiver segurando o S para se agachar
            else 
            {

            //Parado para direita
            if (last_direction === "RIGHT")
            {
                player.anims.play('idleRight', true);
            }

            //Parado para esquerda
            if (last_direction === "LEFT")
            {
                player.anims.play('idleLeft', true);
            }
            
        }
    }
        
    } 
    }


    if (player.body.touching.down === false) //NO AR
    {
        //Checa se o jogador está indo para CIMA e aplica respectivas animações
        if(player.body.velocity.y < 0 && last_direction === "RIGHT")
        {
            player.anims.play('risingRight');
        }

        if(player.body.velocity.y < 0 && last_direction === "LEFT")
        {
            player.anims.play('risingLeft');
        }

        //Checa se o jogador está indo para BAIXO e aplica respectivas animações
        if(player.body.velocity.y > 0 && last_direction === "RIGHT")
        {
            player.anims.play('fallingRight');
        }

        if(player.body.velocity.y > 0 && last_direction === "LEFT")
        {
            player.anims.play('fallingLeft');
        }

        //Define a aceleração do jogador no ar, para que não se movimente livremente fora do chão [DIREITA]
        if (keyD.isDown && player.body.velocity.x <= 200)
        {
            airSpeed = player.body.velocity.x + 5
            player.setVelocityX(airSpeed)


        } 

        //Define a aceleração do jogador no ar, para que não se movimente livremente fora do chão [ESQUERDA]        
        if (keyA.isDown && player.body.velocity.x >= -200)
        {
            airSpeed = player.body.velocity.x - 5
            player.setVelocityX(airSpeed)
            
        } 
    }
}


</script>

</body>
</html>